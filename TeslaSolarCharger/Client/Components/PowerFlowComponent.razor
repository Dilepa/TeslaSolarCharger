@using System.Diagnostics
@using TeslaSolarCharger.Shared.Dtos
@using TeslaSolarCharger.Shared.Dtos.IndexRazor.PvValues
@using TeslaSolarCharger.Shared.Resources
@using TeslaSolarCharger.Shared.Resources.Contracts
@using System.Timers

@inject HttpClient HttpClient
@inject IConstants Constants


<svg width="600" height="400" viewBox="0 0 600 400">
    <!-- Lines -->
    <line x1="100" y1="200" x2="300" y2="100" stroke="black" />
    <line x1="100" y1="200" x2="300" y2="300" stroke="black" />
    <line x1="300" y1="100" x2="500" y2="200" stroke="black" />
    <line x1="300" y1="300" x2="500" y2="200" stroke="black" />

    <!-- Circles -->
    <circle cx="100" cy="200" r="40" fill="lightblue" />
    <circle cx="300" cy="100" r="40" fill="orange" />
    <circle cx="300" cy="300" r="40" fill="pink" />
    <circle cx="500" cy="200" r="40" fill="lightgreen" />

    <!-- Text -->
    <text x="100" y="205" text-anchor="middle">Grid @_pvValues.GridPower W</text>
    <text x="300" y="105" text-anchor="middle">Solar @_pvValues.InverterPower W</text>
    <text x="300" y="305" text-anchor="middle">Battery @_pvValues.HomeBatteryPower W</text>
    <text x="500" y="205" text-anchor="middle">House @ W</text>

    <!-- Animated balls -->
    @foreach (var ball in Balls)
    {
        <circle cx="@ball.X" cy="@ball.Y" r="5" fill="@ball.Color">
            <animate attributeName="cx" from="@ball.StartX" to="@ball.EndX" dur="@ball.Duration" repeatCount="indefinite" />
            <animate attributeName="cy" from="@ball.StartY" to="@ball.EndY" dur="@ball.Duration" repeatCount="indefinite" />
        </circle>
    }
</svg>

@code {
    private List<Ball> Balls { get; set; } = new List<Ball>();
    private Timer? _ballUpdateTimer;

    private DtoPvValues? _pvValues;
    private bool? _isSolarEdgeInstallation;
    private bool? _couldNotRefreshStates;

    private Timer? _pvValueUpdateTimer;


    protected override async Task OnInitializedAsync()
    {
        var dtoSolarChargerInstallation = await HttpClient.GetFromJsonAsync<DtoValue<bool>>("api/Hello/IsSolarEdgeInstallation").ConfigureAwait(false);
        _isSolarEdgeInstallation = dtoSolarChargerInstallation?.Value;

        _pvValueUpdateTimer = new Timer();
        _pvValueUpdateTimer.Interval = Debugger.IsAttached ? 1000 : 5000;
        _pvValueUpdateTimer.Elapsed += async (_, _) => await RefreshPvValues().ConfigureAwait(false);
        _pvValueUpdateTimer.Start();
    }

    private async Task RefreshPvValues()
    {
        try
        {
            _pvValues = await HttpClient.GetFromJsonAsync<DtoPvValues>("api/Index/GetPvValues").ConfigureAwait(false);
            _couldNotRefreshStates = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _couldNotRefreshStates = true;
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        _ballUpdateTimer = new Timer(1000);
        _ballUpdateTimer.Elapsed += (sender, e) => UpdateBalls();
        _ballUpdateTimer.Start();
    }

    private void UpdateBalls()
    {
        Balls.Clear();

        if (SolarPower > 0)
        {
            Balls.Add(new Ball { StartX = 300, StartY = 100, EndX = 500, EndY = 200, Color = "yellow", Duration = "2s" });
        }

        if (GridPower > 0)
        {
            Balls.Add(new Ball { StartX = 100, StartY = 200, EndX = 500, EndY = 200, Color = "blue", Duration = "3s" });
        }

        if (BatteryPower < 0)
        {
            Balls.Add(new Ball { StartX = 300, StartY = 300, EndX = 500, EndY = 200, Color = "red", Duration = "2.5s" });
        }
        else if (BatteryPower > 0)
        {
            Balls.Add(new Ball { StartX = 300, StartY = 100, EndX = 300, EndY = 300, Color = "green", Duration = "2.5s" });
        }

        InvokeAsync(StateHasChanged);
    }

    public class Ball
    {
        public int StartX { get; set; }
        public int StartY { get; set; }
        public int EndX { get; set; }
        public int EndY { get; set; }
        public string Color { get; set; }
        public string Duration { get; set; }
        public int X => StartX;
        public int Y => StartY;
    }

    public void Dispose()
    {
        _ballUpdateTimer?.Dispose();
    }
}